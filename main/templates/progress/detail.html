{% extends "base.html" %}
{% block title %}进度：{{ opus.name }}{% endblock title %}

{% block css %}
<style type="text/css">
    .container {
        font-family: 'Microsoft YaHei';
        padding-top: 50px;
        padding-bottom: 80px;
    }
    .progress-card .table {
        margin: 0;
        font-size: 13px;
    }
    .progress-card .subtitle {
        font-size: 15px;
    }
    .progress-card .persent {
        font-size: 15px;
    }

    /* progress bar */
    .progress-card .progress {
        height: 26px;
        margin: 0;
    }
    .progress-card .progress b{
        font-size: 15px;
    }
    #updateform, #deleteform {
        display: inline-block;
    }
    table td{
        font-size: 14px;
    }
    .editable {
        font-size: 14px !important;
        width: 100%;
        border-bottom: 0 !important;
    }
    .editmode {
        display: none;
    }
    input[name="newcurrent"] {
        text-align: right;
    }
    form {
        margin-bottom: 0;
    }
    .form-group {
        margin-bottom: 0;
    }
    .panel-footer {
        padding: 0
    }
    .fastupdate-total {
        padding-left: 0;
    }
</style>
{% endblock css %}

{% block js %}
<script type="text/javascript">
    $(function(){
    });
    function confirmDelete(){
        var result = confirm("确定删除此进度？")
        if(result){
            $("#deleteform").submit();
        } else {
            $.info("删除操作已取消")
        }
    }
    function enterEdit(){
        $('.viewmode').hide()
        $('.editmode').show()
        $('.editable').removeAttr('readonly')
        $('.text-primary').addClass('danger');
        $.success('输入框已解锁');
    }
    function cancelEdit(){
        $('.editable').attr('readonly','');
        $('.viewmode').show()
        $('.editmode').hide()
        $('input[name="name"]').val('{{opus.name}}')
        $('input[name="subtitle"]').val('{{opus.subtitle}}')
        $('input[name="total"]').val('{{opus.total}}')
        $('input[name="current"]').val('{{prg.current}}')
        $('.text-primary').removeClass('danger');
        $.warning('已撤销修改');
    }
    function saveEdit(){
        var name = $('input[name="name"]').val()
        var subtitle = $('input[name="subtitle"]').val()
        var total = $('input[name="total"]').val()
        var current = $('input[name="current"]').val()
        if(name == ""){
            $.danger('名称不能为空')
            return false;
        }
        if(total == ""){
            $.danger('总页数不能为空、或包含非数字')
            return false;
        }
        if(total == "0"){
            $.danger('总页数不能为 0')
            return false;
        }
        if(current == ""){
            $('input[name="current"]').val("0")
        }
        if(parseInt(current) > parseInt(total)){
            $.danger('当前进度不能大于总页数')
            return false;
        }
        $('#saveform').submit();
    }
    function submitUpdateForm(){
        var newcurrent = $('input[name="newcurrent"]').val();
        var total = $('input[name="total"]').val();
        if( isNaN(newcurrent) ){
            $('input[name="newcurrent"]').parent().addClass('has-error');
            $.danger('输入的更新的进度 '+newcurrent+' 必须是纯数字！')
            return false;
        }
        if( newcurrent == '' ){
            $('input[name="newcurrent"]').parent().addClass('has-error');
            $.danger('当前的更新进度为空 或 存在特殊字符')
            return false;
        }
        if( parseInt(newcurrent) > parseInt(total) ){
             $('input[name="newcurrent"]').parent().addClass('has-error');
            $.danger('当前进度 '+newcurrent+' 超过最大值 '+total);
            return false;
        }
        $("#updateform").submit();
    }
    function addOneCurrent(){
        var newcurrent = $('input[name="newcurrent"]').val();
        var total = $('input[name="total"]').val();
        if( isNaN(newcurrent) ){
            $('input[name="newcurrent"]').parent().addClass('has-error');
            $.danger('当前的更新进度 '+newcurrent+' 必须是纯数字！')
            return false;
        }
        if( newcurrent == '' ){
            $('input[name="newcurrent"]').parent().addClass('has-error');
            $.danger('当前的更新进度为空 或 存在特殊字符')
            return false;
        }
        if( parseInt(newcurrent) >= parseInt(total) ){
             $('input[name="newcurrent"]').parent().addClass('has-error');
            $.warning('进度已达到最大值');
            return false;
        }
        $('input[name="newcurrent"]').val(parseInt(newcurrent)+1);
    }
</script>
{% endblock js %}

{% block nav-btn %}
<a href="/progress/list" class="btn btn-warning btn-sm">
    <span class="glyphicon glyphicon-arrow-left"></span> 回到列表
</a>
{% endblock nav-btn %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-sm-12 col-xs-12 progress-card" progressid="{{ prg.id }}">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    <span class="panel-title">
                        <span class="persent label label-success">{{prg.getPersent}}%</span>
                        <span>《 <b>{{opus.name}}</b> 》</span>
                        {% if opus.subtitle %}
                        <span class="subtitle label label-default">{{opus.subtitle}}</span>
                        {% endif %}
                    </span>
                </div>
                <div class="panel-body">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped active {{prg.getBartype}}" style="width: {{prg.getPersent}}%;">
                            <b>{{prg.current}} / {{opus.total}}</b>
                        </div>
                    </div>
                    <form id="saveform" action="/progress/update/" method="post">
                        <input type="hidden" name="id" value="{{prg.id}}">
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                                <table class="table table-condensed table-hover">
                                    <thead>
                                        <tr>
                                            <th>作品信息</th>
                                            <td class="text-muted text-right">Id:{{opus.id}}</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="text-primary">
                                            <td>名称</td>
                                            <td>
                                                <input type="text" placeholder="{{opus.name}}" name="name" value="{{opus.name}}" readonly class="editable">
                                            </td>
                                        </tr>
                                        <tr class="text-primary">
                                            <td>副标题</td>
                                            <td>
                                                <input type="text" placeholder="{{opus.subtitle}}" name="subtitle" value="{{opus.subtitle}}" readonly class="editable">
                                            </td>
                                        </tr>
                                        <tr class="text-primary">
                                            <td>总页数</td>
                                            <td>
                                                <input type="number" placeholder="{{opus.total}}" name="total" value="{{opus.total}}" readonly class="editable">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>创建时间</td>
                                            <td>{{opus.getCreated}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="clearfix visible-xs-block visible-sm-block">
                                <hr/>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                                <table class="table table-condensed table-hover">
                                    <thead>
                                        <tr>
                                            <th>进度信息</th>
                                            <td class="text-muted text-right">
                                                User:{{prg.userid}} / Opus:{{prg.opusid}} / Id:{{prg.id}}
                                            </td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>状态</td>
                                            <td><b>{{prg.getStatus}}</b></td>
                                        </tr>
                                        <tr>
                                            <td>阅读百分比</td>
                                            <td>{{prg.getPersent}}%</td>
                                        </tr>
                                        <tr class="text-primary">
                                            <td>当前进度</td>
                                            <td>
                                                <input type="number" placeholder="{{prg.current}}" name="current" value="{{prg.current}}" readonly class="editable">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>开始时间</td>
                                            <td>{{prg.getCreated}}</td>
                                        </tr>
                                        <tr>
                                            <td>上次更新</td>
                                            <td>{{prg.getModified}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="panel-footer">
                    <div class="row">
                        <div class="col-xs-12 col-sm-12 col-md-7 col-lg-7">
                            <form id="deleteform" action="/progress/delete/" method="post">
                                <input type="hidden" name="id" value="{{prg.id}}">
                            </form>
                            <form id="giveupform" action="/progress/giveup/" method="post">
                                <input type="hidden" name="id" value="{{prg.id}}">
                            </form>
                            <form id="resetform" action="/progress/reset/" method="post">
                                <input type="hidden" name="id" value="{{prg.id}}">
                            </form>
                            <div class="viewmode">
                                <a class="btn btn-success" id='new' href="/progress/new">新增</a>
                                <a class="btn btn-warning" id='edit' onclick="enterEdit()">进入编辑模式</a>
                                {% if prg.status == 'giveup' %}
                                    <button class="btn btn-danger" id='reset' onclick="$('#resetform').submit()">取消弃置</button>
                                {% else %}
                                    <button class="btn btn-danger" id='giveup' onclick="$('#giveupform').submit()">弃置</button>
                                {% endif %}
                            </div>
                            <span class="editmode">
                                <a class="btn btn-success" id="save" onclick="saveEdit()">保存</a>
                                <a class="btn btn-default" id="cancel" onclick="cancelEdit()">取消</a>
                                <button class="btn btn-danger" id='delete' onclick="confirmDelete()">删除</button>
                            </span>
                        </div>
                        <div class="clearfix visible-xs-block visible-sm-block">
                            <hr/>
                        </div>
                        <div class="col-xs-12 col-sm-12 col-md-5 col-lg-5 text-right">
                            <div class="viewmode text-right">
                                <form id="updateform" action="/progress/fastupdate/" method="post">
                                    <input type="hidden" name="id" value="{{prg.id}}">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <div class="btn btn-primary " onclick="addOneCurrent()">+1</div>
                                            </span>
                                            <input type="number" name="newcurrent" class="form-control"
                                                placeholder="请输入当前进度" value="{{prg.current}}">
                                            <span class="input-group-addon fastupdate-total">/{{opus.total}}</span>
                                            <span class="input-group-btn">
                                                <div class="btn btn-primary" onclick="submitUpdateForm()">更新</div>
                                            </span>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div><!--col-->
    </div><!--row-->
</div>
{% endblock content %}
